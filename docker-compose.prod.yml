# Docker Compose file for ACCESS-CI MCP Servers - Production
# Uses pre-built images from GitHub Container Registry

services:
  # Caddy Reverse Proxy
  caddy:
    image: caddy:2-alpine
    ports:
      - "8443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped
    depends_on:
      - mcp-compute-resources
      - mcp-system-status
      - mcp-software-discovery
      - mcp-xdmod-charts
      - mcp-allocations
      - mcp-nsf-awards
      - mcp-xdmod-data
      - mcp-announcements
      - mcp-events
      - mcp-affinity-groups

  # TypeScript MCP Servers
  mcp-affinity-groups:
    image: ghcr.io/${GITHUB_REPOSITORY:-necyberteam/access-mcp}/affinity-groups:latest
    expose:
      - "3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
    deploy:
      resources:
        limits:
          memory: 128M

  mcp-compute-resources:
    image: ghcr.io/${GITHUB_REPOSITORY:-necyberteam/access-mcp}/compute-resources:latest
    expose:
      - "3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
    deploy:
      resources:
        limits:
          memory: 128M

  mcp-system-status:
    image: ghcr.io/${GITHUB_REPOSITORY:-necyberteam/access-mcp}/system-status:latest
    expose:
      - "3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
    deploy:
      resources:
        limits:
          memory: 128M

  mcp-software-discovery:
    image: ghcr.io/${GITHUB_REPOSITORY:-necyberteam/access-mcp}/software-discovery:latest
    expose:
      - "3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
      - SDS_API_KEY=${SDS_API_KEY}
    deploy:
      resources:
        limits:
          memory: 128M

  mcp-xdmod-charts:
    image: ghcr.io/${GITHUB_REPOSITORY:-necyberteam/access-mcp}/xdmod-charts:latest
    expose:
      - "3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
    deploy:
      resources:
        limits:
          memory: 128M

  mcp-allocations:
    image: ghcr.io/${GITHUB_REPOSITORY:-necyberteam/access-mcp}/allocations:latest
    expose:
      - "3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
      - ACCESS_MCP_SERVICES=${ACCESS_MCP_SERVICES}
    deploy:
      resources:
        limits:
          memory: 128M

  mcp-nsf-awards:
    image: ghcr.io/${GITHUB_REPOSITORY:-necyberteam/access-mcp}/nsf-awards:latest
    expose:
      - "3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
    deploy:
      resources:
        limits:
          memory: 128M

  mcp-announcements:
    image: ghcr.io/${GITHUB_REPOSITORY:-necyberteam/access-mcp}/announcements:latest
    expose:
      - "3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
    deploy:
      resources:
        limits:
          memory: 128M

  mcp-events:
    image: ghcr.io/${GITHUB_REPOSITORY:-necyberteam/access-mcp}/events:latest
    expose:
      - "3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
    deploy:
      resources:
        limits:
          memory: 128M

  # Python MCP Server
  mcp-xdmod-data:
    image: ghcr.io/${GITHUB_REPOSITORY:-necyberteam/access-mcp}/xdmod-mcp-data:latest
    expose:
      - "3000"
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - XDMOD_API_TOKEN=${XDMOD_API_TOKEN}
      - PORT=3000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M

volumes:
  caddy_data:
  caddy_config:

networks:
  default:
    name: mcp-network
